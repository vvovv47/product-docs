# Ola Friend 智能耳机软件需求规格书 (SRS)

**文档版本**: v1.0  
**产品名称**: Ola Friend AI智能体耳机  
**发布日期**: 2025年10月  
**文档状态**: 正式发布  

---

## 目录

1. [软件架构设计](#i-软件架构设计)
2. [功能模块定义](#ii-功能模块定义)
3. [用户交互与状态机](#iii-用户交互与状态机)
4. [算法与数据处理](#iv-算法与数据处理)
5. [OTA与固件管理](#v-ota与固件管理)

---

## I. 软件架构设计

### 1.1 系统分层架构

**[推理]** 基于BES2700ZP嵌入式平台架构：

```mermaid
graph BT
    subgraph 应用层
        A1[语音交互管理]
        A2[音乐播放控制]
        A3[通话管理]
        A4[设备连接管理]
        A5[手势配置管理]
        A6[OTA升级管理]
    end
    
    subgraph 服务层
        S1[蓝牙协议服务]
        S2[音频处理服务]
        S3[电源管理服务]
        S4[触控识别服务]
        S5[LED控制服务]
        S6[语音唤醒服务]
    end
    
    subgraph 中间件层
        M1[FreeRTOS内核]
        M2[任务调度器]
        M3[内存管理]
        M4[定时器管理]
        M5[消息队列]
    end
    
    subgraph 硬件抽象层
        H1[I2C驱动]
        H2[SPI驱动]
        H3[I2S/PDM驱动]
        H4[UART驱动]
        H5[GPIO驱动]
        H6[蓝牙射频驱动]
        H7[电源管理驱动]
    end
    
    subgraph 硬件层
        HW1[BES2700ZP SoC]
        HW2[外设模块]
    end
    
    A1 --> S6
    A1 --> S2
    A2 --> S2
    A3 --> S2
    A4 --> S1
    A5 --> S4
    A6 --> S1
    
    S1 --> M5
    S2 --> M5
    S3 --> M5
    S4 --> M5
    S5 --> M5
    S6 --> M5
    
    M1 --> M2
    M2 --> M3
    M2 --> M4
    M2 --> M5
    
    M5 --> H1
    M5 --> H2
    M5 --> H3
    M5 --> H4
    M5 --> H5
    M5 --> H6
    M5 --> H7
    
    H1 --> HW2
    H2 --> HW2
    H3 --> HW2
    H4 --> HW2
    H5 --> HW2
    H6 --> HW1
    H7 --> HW2
```

### 1.2 任务优先级分配

**[推理]** 基于实时性需求分析：

| 任务名称 | 优先级 | 周期 | 执行时间 | 说明 |
|----------|--------|------|----------|------|
| 蓝牙协议栈 | 1 (最高) | 事件触发 | <5ms | 保证连接稳定性 |
| 音频采集/播放 | 2 | 1ms (1kHz) | <0.5ms | 48kHz音频处理 |
| 触控检测 | 3 | 10ms | <1ms | 触控响应 |
| 语音唤醒 | 4 | 100ms | <10ms | 边缘AI推理 |
| LED控制 | 5 | 50ms | <0.5ms | 灯效更新 |
| 电源管理 | 6 | 1000ms | <5ms | 电量监测 |
| 日志输出 | 7 (最低) | 100ms | <2ms | 调试信息 |

### 1.3 内存分配策略

**[推理]** 基于BES2700ZP内置1MB+ SRAM：

| 内存区域 | 大小 | 用途 | 来源 |
|----------|------|------|------|
| 代码区 (Code) | 512KB | 固件程序存储 | **[推理]** |
| 数据区 (Data) | 256KB | 全局变量、堆 | **[推理]** |
| 栈区 (Stack) | 128KB | 任务栈空间 | **[推理]** |
| 音频缓冲区 | 64KB | PCM音频缓冲 | **[推理]** |
| 保留区 | 64KB | 系统保留 | **[推理]** |

---

## II. 功能模块定义

### 2.1 系统启动模块 (Boot Module)

#### 2.1.1 启动流程

```mermaid
flowchart TD
    Start([上电]) --> HWInit[硬件初始化]
    HWInit --> ClockInit[时钟系统初始化<br/>24MHz主频 + 32.768kHz RTC]
    ClockInit --> MemInit[内存初始化<br/>堆栈配置]
    MemInit --> OSInit[RTOS初始化<br/>FreeRTOS启动]
    OSInit --> DriverInit[驱动初始化<br/>I2C/SPI/I2S/GPIO]
    DriverInit --> PeripheralInit[外设初始化<br/>触控/LED/麦克风]
    PeripheralInit --> BLEInit[蓝牙协议栈初始化]
    BLEInit --> SelfTest[自检程序 POST]
    
    SelfTest --> TestResult{自检结果}
    TestResult -->|通过| AppInit[应用层初始化]
    TestResult -->|失败| ErrorHandle[错误处理<br/>红灯快闪]
    
    AppInit --> CheckBox{入盒检测}
    CheckBox -->|在盒中| DeepSleep[进入深度休眠]
    CheckBox -->|盒外| StandbyMode[进入待机模式]
    
    ErrorHandle --> Halt[系统挂起]
```

#### 2.1.2 自检项目 (POST)

| 检查项 | 检查内容 | 失败处理 | 来源 |
|--------|----------|----------|------|
| 内存自检 | SRAM读写测试 | 红灯快闪2次 | **[推理]** |
| 存储自检 | Flash读写测试 | 红灯快闪3次 | **[推理]** |
| 音频自检 | 扬声器/麦克风测试 | 红灯快闪4次 | **[推理]** |
| 传感器自检 | 触控/霍尔检测 | 红灯快闪5次 | **[推理]** |
| 蓝牙自检 | 射频回路测试 | 红灯快闪6次 | **[推理]** |
| 电池自检 | 电压/电流检测 | 红灯快闪7次 | **[推理]** |

### 2.2 蓝牙连接管理模块

#### 2.2.1 连接状态机

```mermaid
stateDiagram-v2
    [*] --> 未连接: 初始化完成
    
    未连接 --> 广播中: 启动广播
    广播中 --> 连接中: 收到连接请求
    连接中 --> 已连接: 连接建立成功
    连接中 --> 广播中: 连接失败
    
    已连接 --> 已配对: 配对完成
    已配对 --> 已连接: 配对信息清除
    
    已连接 --> 未连接: 断开连接
    已配对 --> 未连接: 断开连接
    
    已连接 --> 连接异常: 信号丢失
    已配对 --> 连接异常: 信号丢失
    
    连接异常 --> 重连中: 启动重连
    重连中 --> 已连接: 重连成功
    重连中 --> 重连中: 重试计数+1
    重连中 --> 未连接: 重连失败(3次)
    
    未连接 --> [*]: 关机
```

#### 2.2.2 双设备管理逻辑

**[事实]** 支持同时连接2台设备：

```
双设备连接优先级规则:

1. 设备角色定义:
   - 主设备: 第一个配对的设备
   - 副设备: 第二个配对的设备

2. 音频抢占规则:
   - 通话 > 音乐 (任意设备)
   - 后发起的通话可抢占先存在的音乐
   - 双设备同时通话时，先响铃的优先

3. 连接维护:
   - 主设备断开时，保持副设备连接
   - 副设备断开时，保持主设备连接
   - 两设备都断开时，进入广播模式

4. 重连策略:
   - 优先重连主设备
   - 主设备重连成功后，再尝试重连副设备
   - 重连间隔: 1s, 2s, 4s (指数退避)
```

### 2.3 语音交互模块

#### 2.3.1 语音唤醒引擎

**[事实]** 支持"豆包豆包"语音唤醒：

| 参数 | 规格 | 实现方式 | 来源 |
|------|------|----------|------|
| 唤醒词 | "豆包豆包" | 边缘AI模型 | **[事实]** |
| 唤醒率 | ≥95% | 神经网络推理 | **[推理]** |
| 误唤醒率 | ≤1次/24h | 阈值自适应 | **[推理]** |
| 响应延迟 | ≤500ms | 本地处理 | **[推理]** |
| 运行功耗 | ≤5mW | 低功耗DSP | **[推理]** |

#### 2.3.2 语音交互流程

```mermaid
flowchart TD
    A[待机状态] -->|持续监听| B{唤醒词检测}
    B -->|未检测到| A
    B -->|检测到豆包| C[唤醒确认]
    B -->|长按触控| C
    
    C --> D[播放唤醒提示音]
    D --> E[开始语音采集]
    
    E --> F{检测输入结束}
    F -->|单击触控| G[结束采集]
    F -->|超时30s| G
    F -->|持续监听| E
    
    G --> H[音频预处理]
    H --> H1[降噪增益]
    H1 --> I[蓝牙传输至手机]
    
    I --> J{传输结果}
    J -->|成功| K[等待云端响应]
    J -->|失败| L[提示网络异常]
    
    K --> M[接收TTS音频]
    M --> N[播放回复]
    N --> O[返回待机]
    
    L --> O
```

### 2.4 触控识别模块

#### 2.4.1 触控事件处理

**[事实]** 支持单击/双击/三击/长按/滑动：

```mermaid
flowchart TD
    A[触控中断触发] --> B[读取触控状态<br/>寄存器0x11]
    B --> C{解析触控类型}
    
    C -->|Bit0=1| D[长按事件]
    C -->|Bit1=1| E[双击事件]
    C -->|Bit2=1| F[单击事件]
    C -->|Bit3=1| G[触摸中...]
    
    D --> H{当前状态}
    H -->|待机| I[启动语音交互]
    H -->|语音中| J[延长监听时间]
    
    E --> K{当前状态}
    K -->|待机| L[播放/暂停音乐]
    K -->|来电中| M[接听/挂断电话]
    
    F --> N{当前状态}
    N -->|语音中| O[终止语音对话]
    N -->|其他| P[忽略]
    
    G --> Q[等待释放] --> R{释放检测}
    R -->|滑动| S[音量调节]
    R -->|释放| T[完成触摸]
```

#### 2.4.2 触控防误触逻辑

| 场景 | 防误触策略 | 实现方式 | 来源 |
|------|------------|----------|------|
| 佩戴误触 | 入盒检测屏蔽 | 霍尔传感器状态判断 | **[推理]** |
| 运动误触 | 加速度阈值过滤 | 运动状态检测 | **[推理]** |
| 连续误触 | 冷却时间机制 | 300ms冷却窗口 | **[推理]** |
| 边缘误触 | 区域识别算法 | 触控坐标过滤 | **[推理]** |

### 2.5 音频处理模块

#### 2.5.1 音频通路管理

```mermaid
flowchart TD
    subgraph 输入通路
        A1[主麦克风 PDM] --> B[PDM转PCM]
        A2[副麦克风 PDM] --> B
        B --> C[双麦降噪DNN]
        C --> D[回声消除]
        D --> E[音频输出]
    end
    
    subgraph 输出通路
        F[蓝牙音频 A2DP] --> G[解码 SBC/AAC]
        G --> H[动态EQ]
        H --> I[DRC低音补偿]
        I --> J[反相声波抵消]
        J --> K[功放驱动]
        K --> L[扬声器输出]
    end
    
    subgraph 反馈通路
        L --> M[漏音检测]
        M --> J
    end
```

#### 2.5.2 音频模式切换

| 模式 | 输入通路 | 输出通路 | 特殊处理 | 来源 |
|------|----------|----------|----------|------|
| 音乐播放 | 关闭 | 蓝牙→EQ→DRC→扬声器 | 反相声波抵消 | **[事实]** |
| 通话上行 | 双麦→降噪→蓝牙 | 关闭 | 回声消除 | **[事实]** |
| 通话下行 | 关闭 | 蓝牙→EQ→扬声器 | 侧音混合 | **[推理]** |
| 语音交互 | 双麦→降噪→蓝牙 | 蓝牙→TTS→扬声器 | 全双工 | **[事实]** |
| 待机 | 唤醒词监听 | 关闭 | 低功耗模式 | **[推理]** |

### 2.6 电源管理模块

#### 2.6.1 功耗状态机

```mermaid
stateDiagram-v2
    [*] --> 全速模式: 开机/唤醒
    
    全速模式 --> 正常模式: 音频播放
    全速模式 --> 正常模式: 通话中
    
    正常模式 --> 省电模式: 待机5s
    正常模式 --> 全速模式: AI交互启动
    
    省电模式 --> 正常模式: 触控/蓝牙事件
    省电模式 --> 深度休眠: 入盒检测
    
    深度休眠 --> 正常模式: 开盒唤醒
    深度休眠 --> 超低功耗: 超时30s
    
    超低功耗 --> 正常模式: 开盒唤醒
    超低功耗 --> 关机: 电量<1%
    
    关机 --> [*]: 系统关闭
```

#### 2.6.2 功耗模式参数

| 模式 | CPU频率 | 外设状态 | 功耗 | 唤醒时间 | 来源 |
|------|---------|----------|------|----------|------|
| 全速模式 | 300MHz | 全开 | 30mW | - | **[推理]** |
| 正常模式 | 150MHz | 音频/蓝牙开 | 15mW | - | **[推理]** |
| 省电模式 | 48MHz | 仅蓝牙维持 | 5mW | <10ms | **[推理]** |
| 深度休眠 | 32kHz | 仅RTC/中断 | 100μW | <50ms | **[推理]** |
| 超低功耗 | 停止 | 仅霍尔检测 | 25μW | <100ms | **[推理]** |

---

## III. 用户交互与状态机

### 3.1 全局设备状态机

```mermaid
stateDiagram-v2
    [*] --> 初始化: 上电
    初始化 --> 自检中: 启动POST
    
    自检中 --> 待机: 自检通过
    自检中 --> 错误状态: 自检失败
    
    待机 --> 配对模式: 长按3s/首次使用
    待机 --> 音乐播放: 双击触控
    待机 --> 语音交互: 唤醒词/长按
    待机 --> 通话中: 来电
    待机 --> 充电中: 入盒检测
    
    配对模式 --> 待机: 配对成功/超时
    
    音乐播放 --> 待机: 暂停/结束
    音乐播放 --> 语音交互: 唤醒词
    
    语音交互 --> 待机: 对话结束
    语音交互 --> 音乐播放: 播放音乐指令
    
    通话中 --> 待机: 挂断
    
    充电中 --> 待机: 开盒取出
    充电中 --> 深度休眠: 充满后超时
    
    错误状态 --> 初始化: 复位
    错误状态 --> 关机: 严重错误
    
    待机 --> 关机: 电量<1%
    关机 --> [*]: 系统关闭
```

### 3.2 LED灯语状态定义

**[推理]** 基于ICD寄存器0x20-0x24控制：

| 设备状态 | LED颜色 | 灯效模式 | 寄存器配置 | 来源 |
|----------|---------|----------|------------|------|
| 开机 | 绿色 | 常亮1s | MODE=00, G=255, 1s后关闭 | **[推理]** |
| 关机 | 红色 | 常亮1s | MODE=00, R=255, 1s后关闭 | **[推理]** |
| 配对模式 | 白色 | 快闪(4Hz) | MODE=10, R=G=B=255, PERIOD=25 | **[推理]** |
| 连接成功 | 白色 | 常亮0.5s | MODE=00, R=G=B=255, 0.5s后关闭 | **[推理]** |
| 充电中 | 橙色 | 呼吸灯 | MODE=01, R=255,G=128, PERIOD=100 | **[推理]** |
| 充电完成 | 绿色 | 常亮 | MODE=00, G=255 | **[推理]** |
| 低电量 | 红色 | 闪烁(1Hz) | MODE=10, R=255, PERIOD=100 | **[推理]** |
| 语音唤醒 | 蓝色 | 呼吸灯 | MODE=01, B=255, PERIOD=50 | **[推理]** |
| 语音输入中 | 蓝色 | 常亮 | MODE=00, B=255 | **[推理]** |
| 错误状态 | 红色 | 快闪次数 | MODE=10, R=255, 次数=错误码 | **[推理]** |

### 3.3 豆包APP界面逻辑

**[事实]** 基于豆包APP的Ola Friend设备管理：

```
APP首页布局 (ASCII线框图)

┌─────────────────────────────────────────┐
│  ←  Ola Friend 设备管理              [] │  ← 标题栏
├─────────────────────────────────────────┤
│                                         │
│     ┌─────────────────────────┐         │
│     │                         │         │
│     │     [耳机图示]          │         │  ← 设备状态区
│     │                         │         │
│     │   左耳 ●───────● 右耳   │         │
│     │   80%          75%      │         │  ← 电量显示
│     │                         │         │
│     └─────────────────────────┘         │
│                                         │
│  充电盒电量: 60%                        │
│                                         │
├─────────────────────────────────────────┤
│  快捷功能                               │
│  ┌────────┐ ┌────────┐ ┌────────┐      │
│  │  降噪  │ │  EQ    │ │  查找  │      │  ← 功能按钮
│  │  设置  │ │  调节  │ │  耳机  │      │
│  └────────┘ └────────┘ └────────┘      │
├─────────────────────────────────────────┤
│  手势设置                               │
│  ┌─────────────────────────────────┐   │
│  │ 双击左耳  ▶  播放/暂停         │   │  ← 手势列表
│  │ 双击右耳  ▶  播放/暂停         │   │
│  │ 长按左耳  ▶  语音助手          │   │
│  │ 长按右耳  ▶  语音助手          │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  更多设置                               │
│  ┌─────────────────────────────────┐   │
│  │  固件升级  >                    │   │
│  │  设备信息  >                    │   │
│  │  使用帮助  >                    │   │
│  │  恢复出厂  >                    │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 3.4 异常处理逻辑

| 异常场景 | 检测方式 | 软件处理 | 用户提示 | 来源 |
|----------|----------|----------|----------|------|
| 蓝牙断连 | 连接状态监控 | 自动重连3次 | 无(静默) | **[推理]** |
| 重连失败 | 重连计数器 | 进入配对模式 | 白灯快闪 | **[推理]** |
| 网络异常 | 数据传输超时 | 缓存数据，提示重试 | "网络不太顺畅" | **[事实]** |
| 电量低(<20%) | ADC电压检测 | 降低功耗，准备休眠 | 红灯闪烁+语音提示 | **[推理]** |
| 电量极低(<5%) | ADC电压检测 | 保存状态，安全关机 | "电量不足，即将关机" | **[推理]** |
| 充电异常 | 充电电流异常 | 停止充电，保护电池 | 红灯快闪 | **[推理]** |
| 温度过高 | 温度传感器 | 暂停充电/降低音量 | "温度过高" | **[推理]** |
| 麦克风异常 | 音频检测 | 切换单麦模式 | "请清洁麦克风" | **[事实]** |
| OTA失败 | 校验失败 | 自动回滚 | "升级失败，请重试" | **[推理]** |

---

## IV. 算法与数据处理

### 4.1 通话降噪算法

**[事实]** 双麦克风智能降噪算法：

```mermaid
flowchart LR
    subgraph 输入
        A1[主麦克风信号]
        A2[副麦克风信号]
    end
    
    subgraph 预处理
        B1[预加重]
        B2[分帧加窗]
        B3[FFT变换]
    end
    
    subgraph 核心算法
        C1[波束成形]
        C2[噪声估计]
        C3[AI降噪DNN]
        C4[后处理]
    end
    
    subgraph 输出
        D[纯净语音]
    end
    
    A1 --> B1 --> B2 --> B3
    A2 --> B1
    B3 --> C1 --> C2 --> C3 --> C4 --> D
```

#### 4.1.1 算法参数

| 参数 | 值 | 说明 | 来源 |
|------|-----|------|------|
| 采样率 | 16kHz | 通话语音 | **[推理]** |
| 帧长 | 20ms | 处理粒度 | **[推理]** |
| 帧移 | 10ms | 50%重叠 | **[推理]** |
| FFT点数 | 512 | 频域分析 | **[推理]** |
| 降噪深度 | ≥20dB | 稳态噪声 | **[事实]** |
| 算法延迟 | ≤20ms | 端到端 | **[事实]** |

### 4.2 语音唤醒算法

#### 4.2.1 唤醒引擎架构

```
语音唤醒处理流程

┌─────────────────────────────────────────────────────────────┐
│  音频输入 (16kHz, 16bit)                                    │
│       │                                                     │
│       ▼                                                     │
│  ┌─────────────┐                                           │
│  │  特征提取   │  MFCC/Mel滤波器组                          │
│  │  40维特征   │  25ms帧长, 10ms帧移                        │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │  神经网络   │  轻量级CNN/RNN模型                          │
│  │  推理引擎   │  运行在DSP核心                              │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────┐                                           │
│  │  唤醒词检测 │  "豆包豆包" 置信度阈值                      │
│  │  置信度>0.9 │  触发唤醒中断                               │
│  └──────┬──────┘                                           │
│         │                                                   │
│         ▼                                                   │
│  唤醒事件 → 主控中断 → 启动语音交互流程                      │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2.2 性能指标

| 指标 | 目标值 | 测试条件 | 来源 |
|------|--------|----------|------|
| 唤醒率 | ≥95% | 安静环境, 1米距离 | **[推理]** |
| 误唤醒率 | ≤1次/24h | 日常环境 | **[推理]** |
| 响应延迟 | ≤500ms | 从语音结束到唤醒 | **[推理]** |
| 功耗 | ≤5mW | 持续监听状态 | **[推理]** |

### 4.3 动态EQ与DRC算法

**[事实]** 动态EQ1.0和DRC低音补偿：

```mermaid
flowchart LR
    A[输入音频] --> B[频谱分析]
    B --> C{音乐类型识别}
    
    C -->|流行| D1[流行EQ曲线]
    C -->|古典| D2[古典EQ曲线]
    C -->|摇滚| D3[摇滚EQ曲线]
    C -->|人声| D4[人声EQ曲线]
    
    D1 --> E[动态EQ应用]
    D2 --> E
    D3 --> E
    D4 --> E
    
    E --> F[低频检测]
    F --> G{DRC处理}
    G -->|低频不足| H[低音补偿]
    G -->|低频正常| I[直通]
    
    H --> J[输出音频]
    I --> J
```

---

## V. OTA与固件管理

### 5.1 OTA升级流程

```mermaid
flowchart TD
    A[APP检测新版本] --> B{版本比较}
    B -->|有新版本| C[提示用户升级]
    B -->|已最新| D[结束]
    
    C --> E[用户确认升级]
    E --> F[下载固件包]
    F --> G{下载校验}
    G -->|成功| H[进入OTA模式]
    G -->|失败| I[提示重试]
    I --> F
    
    H --> J[擦除旧固件]
    J --> K[写入新固件]
    K --> L{写入校验}
    L -->|成功| M[更新版本号]
    L -->|失败| N[回滚到旧版本]
    
    M --> O[重启设备]
    O --> P[启动新固件]
    N --> Q[提示升级失败]
    Q --> R[恢复正常使用]
```

### 5.2 固件安全机制

| 机制 | 实现方式 | 说明 | 来源 |
|------|----------|------|------|
| 签名验证 | RSA/ECDSA | 固件包数字签名 | **[推理]** |
| 版本校验 | 版本号比较 | 防止降级攻击 | **[推理]** |
| CRC校验 | 32位CRC | 数据完整性 | **[推理]** |
| 双区备份 | A/B分区 | 失败可回滚 | **[推理]** |
| 断电保护 | 原子写入 | 断电不损坏 | **[推理]** |

### 5.3 固件版本管理

| 版本字段 | 格式 | 示例 | 说明 | 来源 |
|----------|------|------|------|------|
| 主版本 | X | 1 | 重大更新 | **[推理]** |
| 次版本 | Y | 2 | 功能新增 | **[推理]** |
| 修订版本 | Z | 3 | Bug修复 | **[推理]** |
| 构建号 | B | 456 | CI构建编号 | **[推理]** |
| 完整版本 | X.Y.Z.B | 1.2.3.456 | - | **[推理]** |

---

## 附录

### A. 任务调度配置

```c
// FreeRTOS任务配置示例 (伪代码)

// 任务优先级定义
typedef enum {
    TASK_PRIO_BT_STACK = 1,      // 蓝牙协议栈 (最高)
    TASK_PRIO_AUDIO = 2,         // 音频处理
    TASK_PRIO_TOUCH = 3,         // 触控检测
    TASK_PRIO_VOICE_WAKEUP = 4,  // 语音唤醒
    TASK_PRIO_LED = 5,           // LED控制
    TASK_PRIO_POWER = 6,         // 电源管理
    TASK_PRIO_LOG = 7            // 日志输出 (最低)
} TaskPriority_t;

// 任务创建参数
TaskConfig_t taskConfigs[] = {
    {"BT_Stack", 4096, TASK_PRIO_BT_STACK, 10},
    {"Audio", 2048, TASK_PRIO_AUDIO, 1},
    {"Touch", 1024, TASK_PRIO_TOUCH, 10},
    {"VoiceWakeup", 2048, TASK_PRIO_VOICE_WAKEUP, 100},
    {"LED", 512, TASK_PRIO_LED, 50},
    {"Power", 1024, TASK_PRIO_POWER, 1000},
    {"Log", 512, TASK_PRIO_LOG, 100}
};
```

### B. 消息队列定义

| 队列名称 | 消息大小 | 队列深度 | 生产者 | 消费者 | 来源 |
|----------|----------|----------|--------|--------|------|
| qTouchEvent | 4字节 | 10 | 触控中断 | 触控服务 | **[推理]** |
| qAudioIn | 512字节 | 20 | PDM驱动 | 音频处理 | **[推理]** |
| qAudioOut | 512字节 | 20 | 蓝牙服务 | I2S驱动 | **[推理]** |
| qBLECmd | 32字节 | 10 | 蓝牙协议栈 | 应用层 | **[推理]** |
| qVoiceData | 1024字节 | 50 | 音频采集 | 蓝牙传输 | **[推理]** |
| qPowerEvent | 4字节 | 5 | 电源中断 | 电源服务 | **[推理]** |

### C. 软件模块依赖关系

```mermaid
graph TD
    subgraph 应用层
        APP1[语音交互]
        APP2[音乐控制]
        APP3[通话管理]
    end
    
    subgraph 服务层
        SVC1[蓝牙服务]
        SVC2[音频服务]
        SVC3[触控服务]
        SVC4[电源服务]
    end
    
    subgraph 驱动层
        DRV1[I2C驱动]
        DRV2[SPI驱动]
        DRV3[I2S驱动]
        DRV4[GPIO驱动]
    end
    
    APP1 --> SVC1
    APP1 --> SVC2
    APP2 --> SVC2
    APP3 --> SVC1
    APP3 --> SVC2
    
    SVC1 --> DRV4
    SVC2 --> DRV3
    SVC3 --> DRV1
    SVC3 --> DRV4
    SVC4 --> DRV4
```

### D. 术语表

| 术语 | 说明 |
|------|------|
| HAL | Hardware Abstraction Layer，硬件抽象层 |
| RTOS | Real-Time Operating System，实时操作系统 |
| ISR | Interrupt Service Routine，中断服务程序 |
| DMA | Direct Memory Access，直接内存访问 |
| PDM | Pulse Density Modulation，脉冲密度调制 |
| PCM | Pulse Code Modulation，脉冲编码调制 |
| DRC | Dynamic Range Compression，动态范围压缩 |
| EQ | Equalizer，均衡器 |
| OTA | Over-The-Air，空中升级 |
| POST | Power-On Self Test，上电自检 |
| DNN | Deep Neural Network，深度神经网络 |
| MFCC | Mel-Frequency Cepstral Coefficients，梅尔频率倒谱系数 |

### E. 参考文档

1. FreeRTOS官方文档: https://www.freertos.org/
2. BES2700ZP SDK开发指南
3. 蓝牙Core Specification v5.4
4. 语音唤醒算法技术白皮书
5. 双麦降噪算法设计规范

---

**文档维护记录**

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-10 | 初始版本 | SRS自动生成 |

---

*本文档基于Ola Friend智能耳机调研报告、产品需求文档和接口控制文档生成，包含[事实]、[关联]和[推理]三类信息，请在设计开发过程中以实际测试结果为准。*
